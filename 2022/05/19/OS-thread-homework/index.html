<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"puitar.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="操作系统第三部分作业作业范围 第26章1、2、3、4题 第28章1、2、3、4、5、6、7题 第30章1、2、4、8、9、10、11题 第31章1、2、4、5、6题  第26章1.首先查看这个程序，得到结果如下 123456789sh&gt; cat loop.s# 段符号.main.top# 重点看下面这4句sub  $1,%dx		# %dx &#x3D; %dx - 1test $0,%dx		# %">
<meta property="og:type" content="article">
<meta property="og:title" content="OS-thread-homework">
<meta property="og:url" content="https://puitar.github.io/2022/05/19/OS-thread-homework/index.html">
<meta property="og:site_name" content="Puitar&#39;s Blog">
<meta property="og:description" content="操作系统第三部分作业作业范围 第26章1、2、3、4题 第28章1、2、3、4、5、6、7题 第30章1、2、4、8、9、10、11题 第31章1、2、4、5、6题  第26章1.首先查看这个程序，得到结果如下 123456789sh&gt; cat loop.s# 段符号.main.top# 重点看下面这4句sub  $1,%dx		# %dx &#x3D; %dx - 1test $0,%dx		# %">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220516082241930.png">
<meta property="og:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220516085555854.png">
<meta property="og:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220516100021157.png">
<meta property="og:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220516101427280.png">
<meta property="og:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220516103344533.png">
<meta property="og:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220516105426143.png">
<meta property="og:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220516105828890.png">
<meta property="og:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220516112113947.png">
<meta property="og:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220516114048979.png">
<meta property="og:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220517094824131.png">
<meta property="og:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220517114856648.png">
<meta property="og:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220517115033332.png">
<meta property="og:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220517121316512.png">
<meta property="og:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220517123707241.png">
<meta property="og:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220517131624836.png">
<meta property="og:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220517133750012.png">
<meta property="og:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220517145756037.png">
<meta property="og:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220517145842415.png">
<meta property="og:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220519222752600.png">
<meta property="article:published_time" content="2022-05-19T14:26:30.000Z">
<meta property="article:modified_time" content="2022-05-26T16:25:05.301Z">
<meta property="article:author" content="Puitar">
<meta property="article:tag" content="ostep-homework">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://puitar.github.io/2022/05/19/OS-thread-homework/image-20220516082241930.png">

<link rel="canonical" href="https://puitar.github.io/2022/05/19/OS-thread-homework/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>OS-thread-homework | Puitar's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Puitar's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://puitar.github.io/2022/05/19/OS-thread-homework/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Puitar">
      <meta itemprop="description" content="博客萌新时不时送来没什么软用的文章">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Puitar's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          OS-thread-homework
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-19 22:26:30" itemprop="dateCreated datePublished" datetime="2022-05-19T22:26:30+08:00">2022-05-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-27 00:25:05" itemprop="dateModified" datetime="2022-05-27T00:25:05+08:00">2022-05-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/courses-learning/" itemprop="url" rel="index"><span itemprop="name">courses-learning</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="操作系统第三部分作业"><a href="#操作系统第三部分作业" class="headerlink" title="操作系统第三部分作业"></a>操作系统第三部分作业</h1><h2 id="作业范围"><a href="#作业范围" class="headerlink" title="作业范围"></a>作业范围</h2><ul>
<li>第26章1、2、3、4题</li>
<li>第28章1、2、3、4、5、6、7题</li>
<li>第30章1、2、4、8、9、10、11题</li>
<li>第31章1、2、4、5、6题</li>
</ul>
<h2 id="第26章"><a href="#第26章" class="headerlink" title="第26章"></a>第26章</h2><h3 id="1"><a href="#1" class="headerlink" title="1."></a>1.</h3><p>首先查看这个程序，得到结果如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sh&gt; <span class="built_in">cat</span> loop.s</span><br><span class="line"><span class="comment"># 段符号</span></span><br><span class="line">.main</span><br><span class="line">.top</span><br><span class="line"><span class="comment"># 重点看下面这4句</span></span><br><span class="line">sub  <span class="variable">$1</span>,%dx		<span class="comment"># %dx = %dx - 1</span></span><br><span class="line"><span class="built_in">test</span> <span class="variable">$0</span>,%dx		<span class="comment"># %dx &amp; $0 不改变%dx的值，仅仅改变标志位</span></span><br><span class="line">jgte .top		<span class="comment"># 表示如果大于等于就跳到.top</span></span><br><span class="line">halt			<span class="comment"># 停机</span></span><br></pre></td></tr></table></figure>
<p>现在我们理解了<code>loop.s</code>句子的含义。现在我们看看题目，假设dx的初始值是0，很快就可以计算出每个指令执行的时候dx的值。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ./x86.py -p loop.s -t 1 -i 100 -R dx</span><br><span class="line">...</span><br><span class="line">   dx          Thread 0</span><br><span class="line">    0</span><br><span class="line">   -1   1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">   -1   1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">   -1   1002 jgte .top</span><br><span class="line">   -1   1003 halt</span><br></pre></td></tr></table></figure>
<p>dx作为循环变量判断是否跳出循环，上述语句可以写成c语言的语句如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i = n;</span><br><span class="line"><span class="keyword">while</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">	i--;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以它的价值就在于循环递减变量以及循环变量判断是否跳出循环。</p>
<h3 id="2"><a href="#2" class="headerlink" title="2."></a>2.</h3><p>现在运行相同的代码，但是使用如下标志，但是设定了寄存器的初始值如<code>-a</code>后面所赋值。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ ./x86.py -p loop.s -t 2 -i 100 -a dx=3,dx=3 -R dx</span><br><span class="line">...</span><br><span class="line">   dx          Thread 0                Thread 1</span><br><span class="line">    3</span><br><span class="line">    2   1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    2   1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    2   1002 jgte .top</span><br><span class="line">    1   1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    1   1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    1   1002 jgte .top</span><br><span class="line">    0   1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    0   1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    0   1002 jgte .top</span><br><span class="line">   -1   1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">   -1   1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">   -1   1002 jgte .top</span><br><span class="line">   -1   1003 halt</span><br><span class="line">    3   ----- Halt;Switch -----  ----- Halt;Switch -----</span><br><span class="line">    2                            1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    2                            1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    2                            1002 jgte .top</span><br><span class="line">    1                            1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    1                            1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    1                            1002 jgte .top</span><br><span class="line">    0                            1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    0                            1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    0                            1002 jgte .top</span><br><span class="line">   -1                            1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">   -1                            1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">   -1                            1002 jgte .top</span><br><span class="line">   -1                            1003 halt</span><br></pre></td></tr></table></figure>
<p>在这种情况下，多线程不会影响结果的运行，因为两个线程执行的时候不是共享同一个<code>edx</code>的。这种情况下，两个线程只使用自己的dx的值，dx在每个线程从3到-1。并且在中断前halt跳出循环。</p>
<p>至于这段代码是否有竞态条件？首先要弄清楚什么叫竞态条件等两个基本概念。</p>
<blockquote>
<ul>
<li>临界区：访问共享资源的一段代码，资源通常是一个变量或数据结构。</li>
<li>竞态条件：出现在多个执行线程同时进入临界区时，他们都试图更新共享的数据结构导致了不确定结果</li>
</ul>
</blockquote>
<p>这一段<code>loop.s</code>中对共享资源更新的部分的代码就是<code>sub</code>指令这一条。因此因此我们可以看临界区就是这一段<code>loop.s</code>或者就是<code>sub</code>这一句。很明显从在这种情况下，线程每100条指令中断1次，而还没到100条指令就已经跳出循环了。这种情况下可以看出来，两段代码是没有竞态条件的。</p>
<h3 id="3"><a href="#3" class="headerlink" title="3."></a>3.</h3><p>这一组测试使得中断间隔非常小而且随机，使用不同的种子<code>-s</code>查看不同的交替。中断频率是否会改变这个程序的行为。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ ./x86.py -p loop.s -t 2 -i 3 -r -a dx=3,dx=3 -R dx</span><br><span class="line">...</span><br><span class="line">   dx          Thread 0                Thread 1</span><br><span class="line">    3</span><br><span class="line">    2   1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    2   1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    2   1002 jgte .top</span><br><span class="line">    3   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    2                            1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    2                            1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    2                            1002 jgte .top</span><br><span class="line">    2   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    1   1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    1   1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    2   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    1                            1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    1   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    1   1002 jgte .top</span><br><span class="line">    0   1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    1   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    1                            1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    1                            1002 jgte .top</span><br><span class="line">    0   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    0   1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    0   1002 jgte .top</span><br><span class="line">   -1   1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    1   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    0                            1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">   -1   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">   -1   1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">   -1   1002 jgte .top</span><br><span class="line">    0   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    0                            1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    0                            1002 jgte .top</span><br><span class="line">   -1   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">   -1   1003 halt</span><br><span class="line">    0   ----- Halt;Switch -----  ----- Halt;Switch -----</span><br><span class="line">   -1                            1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">   -1                            1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">   -1   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">   -1                            1002 jgte .top</span><br><span class="line">   -1                            1003 halt</span><br></pre></td></tr></table></figure>
<p>再看看不同的随机种子下是什么样的结果。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">$ ./x86.py -p loop.s -t 2 -i 3 -r -a dx=3,dx=3 -R dx -c -s 1</span><br><span class="line">...</span><br><span class="line">   dx          Thread 0                Thread 1</span><br><span class="line">    3</span><br><span class="line">    2   1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    3   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    2                            1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    2                            1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    2                            1002 jgte .top</span><br><span class="line">    2   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    2   1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    2   1002 jgte .top</span><br><span class="line">    1   1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    2   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    1                            1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    1   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    1   1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    1   1002 jgte .top</span><br><span class="line">    1   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    1                            1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    1                            1002 jgte .top</span><br><span class="line">    1   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    0   1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    0   1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    1   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    0                            1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    0                            1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    0                            1002 jgte .top</span><br><span class="line">    0   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    0   1002 jgte .top</span><br><span class="line">    0   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">   -1                            1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    0   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">   -1   1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">   -1   1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">   -1   1002 jgte .top</span><br><span class="line">   -1   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">   -1                            1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">   -1                            1002 jgte .top</span><br><span class="line">   -1   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">   -1   1003 halt</span><br><span class="line">   -1   ----- Halt;Switch -----  ----- Halt;Switch -----</span><br><span class="line">   -1                            1003 halt</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">./x86.py -p loop.s -t 2 -i 3 -r -a dx=3,dx=3 -R dx -c -s 2</span><br><span class="line">...</span><br><span class="line">   dx          Thread 0                Thread 1</span><br><span class="line">    3</span><br><span class="line">    2   1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    2   1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    2   1002 jgte .top</span><br><span class="line">    3   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    2                            1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    2                            1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    2                            1002 jgte .top</span><br><span class="line">    2   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    1   1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    2   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    1                            1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    1   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    1   1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    1   1002 jgte .top</span><br><span class="line">    0   1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    1   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    1                            1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    1                            1002 jgte .top</span><br><span class="line">    0                            1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    0   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    0   1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">    0   1002 jgte .top</span><br><span class="line">   -1   1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">    0   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    0                            1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">   -1   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">   -1   1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">   -1   1002 jgte .top</span><br><span class="line">    0   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    0                            1002 jgte .top</span><br><span class="line">   -1                            1000 sub  <span class="variable">$1</span>,%dx</span><br><span class="line">   -1   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">   -1   1003 halt</span><br><span class="line">   -1   ----- Halt;Switch -----  ----- Halt;Switch -----</span><br><span class="line">   -1                            1001 <span class="built_in">test</span> <span class="variable">$0</span>,%dx</span><br><span class="line">   -1   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">   -1                            1002 jgte .top</span><br><span class="line">   -1   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">   -1                            1003 halt</span><br></pre></td></tr></table></figure>
<p>总体看来，两个线程仍然是执行了从3到-1的循环操作，但是由于中断具有随机性，因此也就不能够确定什么时候执行完毕。从工作执行总量上看没有发生改变，但就工作执行的先后以及连续性上，改变了行为。</p>
<h3 id="4"><a href="#4" class="headerlink" title="4."></a>4.</h3><p>第四题是访问一个公共变量而不是寄存器，在前面3题中，每个线程都有自己的专属寄存器。在中断的时候，线程的寄存器会保存，在恢复中断恢复的时候寄存器的值会被恢复。因此在循环上不会被破坏。但是现在的公共资源是一个变量，这可能引起某些变化。具体见下面。</p>
<p>首先看看这个程序<code>looping-race-nolock.s</code>是什么意思</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ cat looping-race-nolock.s</span><br><span class="line"># assumes %bx has loop count in it</span><br><span class="line"></span><br><span class="line">.main</span><br><span class="line">.top</span><br><span class="line"># critical section 临界区</span><br><span class="line">mov 2000, %ax  # get &#x27;value&#x27; at address 2000</span><br><span class="line">add $1, %ax    # increment it: ax += 1</span><br><span class="line">mov %ax, 2000  # store it back</span><br><span class="line"></span><br><span class="line"># see if we&#x27;re still looping</span><br><span class="line">sub  $1, %bx</span><br><span class="line">test $0, %bx</span><br><span class="line">jgt .top</span><br><span class="line"></span><br><span class="line">halt</span><br></pre></td></tr></table></figure>
<p>可以看出来bx是循环变量，要对ax进行加一操作，可以写出程序的c语言表达如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i = n;</span><br><span class="line"><span class="type">int</span> x;</span><br><span class="line"><span class="type">int</span> *p;</span><br><span class="line"><span class="keyword">while</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    *p = x;</span><br><span class="line">    *p--;</span><br><span class="line">    i--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们再来看看下面这段执行情况。显然除了<code>mov %ax 2000</code>这个语句会更新2000地址的变量x的值，其余时刻都不会更新。因此结果如下。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ./x86.py -p looping-race-nolock.s -t 1 -M 2000</span><br><span class="line">...</span><br><span class="line"> 2000          Thread 0</span><br><span class="line">    0</span><br><span class="line">    0   1000 mov 2000, %ax</span><br><span class="line">    0   1001 add <span class="variable">$1</span>, %ax</span><br><span class="line">    1   1002 mov %ax, 2000</span><br><span class="line">    1   1003 sub  <span class="variable">$1</span>, %bx</span><br><span class="line">    1   1004 <span class="built_in">test</span> <span class="variable">$0</span>, %bx</span><br><span class="line">    1   1005 jgt .top</span><br><span class="line">    1   1006 halt</span><br></pre></td></tr></table></figure>
<h2 id="第28章"><a href="#第28章" class="headerlink" title="第28章"></a>第28章</h2><p>这一章的习题同样是一个用python写的x86模拟器，它能够运行<code>.s</code>格式的文件。</p>
<p>在这里，我们有四个常用的寄存器ax、bx、cx、dx，还有一个程序计数器PC。还有足够小但是能够满足我们需求的汇编指令。我们也加了一些额外的寄存器，例如ex和fx，这不见得能够与x86是对应的。但是这并没有什么问题。</p>
<h3 id="1-1"><a href="#1-1" class="headerlink" title="1."></a>1.</h3><p>这题要我们用./x86运行<code>flag.s</code>文件。首先理解一下<code>flag.s</code>到底说了什么。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> flag.s</span><br><span class="line">.var flag</span><br><span class="line">.var count</span><br><span class="line"></span><br><span class="line">.main</span><br><span class="line">.top</span><br><span class="line"></span><br><span class="line">.acquire</span><br><span class="line">mov  flag, %ax      <span class="comment"># get flag</span></span><br><span class="line"><span class="built_in">test</span> <span class="variable">$0</span>, %ax        <span class="comment"># if we get 0 back: lock is free!</span></span><br><span class="line">jne  .acquire       <span class="comment"># if not, try again</span></span><br><span class="line">mov  <span class="variable">$1</span>, flag       <span class="comment"># store 1 into flag</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># critical section</span></span><br><span class="line">mov  count, %ax     <span class="comment"># get the value at the address</span></span><br><span class="line">add  <span class="variable">$1</span>, %ax        <span class="comment"># increment it</span></span><br><span class="line">mov  %ax, count     <span class="comment"># store it back</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># release lock</span></span><br><span class="line">mov  <span class="variable">$0</span>, flag       <span class="comment"># clear the flag now</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># see if we&#x27;re still looping</span></span><br><span class="line">sub  <span class="variable">$1</span>, %bx</span><br><span class="line"><span class="built_in">test</span> <span class="variable">$0</span>, %bx</span><br><span class="line">jgt .top</span><br><span class="line"></span><br><span class="line">halt</span><br></pre></td></tr></table></figure>
<p>上面这部分汇编代码其实很好理解，根据上面的注释，我们可以写出c语言版本</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">char</span> <span class="type">mutex_t</span>;</span><br><span class="line"><span class="type">mutex_t</span> flag = <span class="number">0x0</span>;</span><br><span class="line"><span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> i = n;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">mian</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">/* 上锁 */</span></span><br><span class="line">        <span class="keyword">while</span> (flag != <span class="number">0x0</span>)</span><br><span class="line">            ; <span class="comment">// 自选等待锁空闲</span></span><br><span class="line">        <span class="comment">/* lock */</span></span><br><span class="line">        flag = <span class="number">0x1</span>;</span><br><span class="line">        <span class="comment">/* 临界区代码 */</span></span><br><span class="line">        count++;</span><br><span class="line">        <span class="comment">/* unlock */</span></span><br><span class="line">        flag = <span class="number">0x0</span>;</span><br><span class="line">        <span class="comment">/* 判断是否继续循环 */</span></span><br><span class="line">        i--;	</span><br><span class="line">    &#125; <span class="keyword">while</span> (i &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="comment">/* halt */</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以<code>flag.s</code>的功能就是在循环变量被减到0之前不断申请上锁，然后对公共资源count++，然后释放锁的过程。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$./x86.py -p flag.s</span><br><span class="line">...</span><br><span class="line">       Thread 0                Thread 1</span><br><span class="line"></span><br><span class="line">1000 mov  flag, %ax</span><br><span class="line">1001 <span class="built_in">test</span> <span class="variable">$0</span>, %ax</span><br><span class="line">1002 jne  .acquire</span><br><span class="line">1003 mov  <span class="variable">$1</span>, flag</span><br><span class="line">1004 mov  count, %ax</span><br><span class="line">1005 add  <span class="variable">$1</span>, %ax</span><br><span class="line">1006 mov  %ax, count</span><br><span class="line">1007 mov  <span class="variable">$0</span>, flag</span><br><span class="line">1008 sub  <span class="variable">$1</span>, %bx</span><br><span class="line">1009 <span class="built_in">test</span> <span class="variable">$0</span>, %bx</span><br><span class="line">1010 jgt .top</span><br><span class="line">1011 halt</span><br><span class="line">----- Halt;Switch -----  ----- Halt;Switch -----</span><br><span class="line">                         1000 mov  flag, %ax</span><br><span class="line">                         1001 <span class="built_in">test</span> <span class="variable">$0</span>, %ax</span><br><span class="line">                         1002 jne  .acquire</span><br><span class="line">                         1003 mov  <span class="variable">$1</span>, flag</span><br><span class="line">                         1004 mov  count, %ax</span><br><span class="line">                         1005 add  <span class="variable">$1</span>, %ax</span><br><span class="line">                         1006 mov  %ax, count</span><br><span class="line">                         1007 mov  <span class="variable">$0</span>, flag</span><br><span class="line">                         1008 sub  <span class="variable">$1</span>, %bx</span><br><span class="line">                         1009 <span class="built_in">test</span> <span class="variable">$0</span>, %bx</span><br><span class="line">                         1010 jgt .top</span><br><span class="line">                         1011 halt</span><br></pre></td></tr></table></figure>
<p>和上面的26的作业类似，在中断时间片较短的时候，两个线程都能够完成各自的工作。这个时候，count能够获得两个线程的累加工作，并获得确定的答案。既能够获得某个线程两倍的累加量。</p>
<h3 id="2-1"><a href="#2-1" class="headerlink" title="2."></a>2.</h3><p>上面其实已经解释了。答案是会的，能够按照预期工作。我们可以详细跟踪各个变量和寄存器的值看看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$./x86.py -p flag.s -R ax,bx -M flag,count -c</span><br><span class="line">...</span><br><span class="line"> flag count      ax    bx          Thread 0                Thread 1</span><br><span class="line"></span><br><span class="line">    0     0       0     0</span><br><span class="line">    0     0       0     0   1000 mov  flag, %ax</span><br><span class="line">    0     0       0     0   1001 <span class="built_in">test</span> <span class="variable">$0</span>, %ax</span><br><span class="line">    0     0       0     0   1002 jne  .acquire</span><br><span class="line">    1     0       0     0   1003 mov  <span class="variable">$1</span>, flag</span><br><span class="line">    1     0       0     0   1004 mov  count, %ax</span><br><span class="line">    1     0       1     0   1005 add  <span class="variable">$1</span>, %ax</span><br><span class="line">    1     1       1     0   1006 mov  %ax, count</span><br><span class="line">    0     1       1     0   1007 mov  <span class="variable">$0</span>, flag</span><br><span class="line">    0     1       1    -1   1008 sub  <span class="variable">$1</span>, %bx</span><br><span class="line">    0     1       1    -1   1009 <span class="built_in">test</span> <span class="variable">$0</span>, %bx</span><br><span class="line">    0     1       1    -1   1010 jgt .top</span><br><span class="line">    0     1       1    -1   1011 halt</span><br><span class="line">    0     1       0     0   ----- Halt;Switch -----  ----- Halt;Switch -----</span><br><span class="line">    0     1       0     0                            1000 mov  flag, %ax</span><br><span class="line">    0     1       0     0                            1001 <span class="built_in">test</span> <span class="variable">$0</span>, %ax</span><br><span class="line">    0     1       0     0                            1002 jne  .acquire</span><br><span class="line">    1     1       0     0                            1003 mov  <span class="variable">$1</span>, flag</span><br><span class="line">    1     1       1     0                            1004 mov  count, %ax</span><br><span class="line">    1     1       2     0                            1005 add  <span class="variable">$1</span>, %ax</span><br><span class="line">    1     2       2     0                            1006 mov  %ax, count</span><br><span class="line">    0     2       2     0                            1007 mov  <span class="variable">$0</span>, flag</span><br><span class="line">    0     2       2    -1                            1008 sub  <span class="variable">$1</span>, %bx</span><br><span class="line">    0     2       2    -1                            1009 <span class="built_in">test</span> <span class="variable">$0</span>, %bx</span><br><span class="line">    0     2       2    -1                            1010 jgt .top</span><br><span class="line">    0     2       2    -1                            1011 halt</span><br></pre></td></tr></table></figure>
<p>可以看到两个线程的循环变量寄存器都是bx，它们都是1，说明可以各自累加一次。count的初始值是0，所以最终各自累加一次，可以看到最后count的值恰好是2，证明了可以按照预期工作。</p>
<h3 id="3-1"><a href="#3-1" class="headerlink" title="3."></a>3.</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">$./x86.py -p flag.s -R ax,bx -M flag,count -c -a bx=2,bx=2</span><br><span class="line">...</span><br><span class="line"> flag count      ax    bx          Thread 0                Thread 1</span><br><span class="line"></span><br><span class="line">    0     0       0     2</span><br><span class="line">    0     0       0     2   1000 mov  flag, %ax</span><br><span class="line">    0     0       0     2   1001 <span class="built_in">test</span> <span class="variable">$0</span>, %ax</span><br><span class="line">    0     0       0     2   1002 jne  .acquire</span><br><span class="line">    1     0       0     2   1003 mov  <span class="variable">$1</span>, flag</span><br><span class="line">    1     0       0     2   1004 mov  count, %ax</span><br><span class="line">    1     0       1     2   1005 add  <span class="variable">$1</span>, %ax</span><br><span class="line">    1     1       1     2   1006 mov  %ax, count</span><br><span class="line">    0     1       1     2   1007 mov  <span class="variable">$0</span>, flag</span><br><span class="line">    0     1       1     1   1008 sub  <span class="variable">$1</span>, %bx</span><br><span class="line">    0     1       1     1   1009 <span class="built_in">test</span> <span class="variable">$0</span>, %bx</span><br><span class="line">    0     1       1     1   1010 jgt .top</span><br><span class="line">    0     1       0     1   1000 mov  flag, %ax</span><br><span class="line">    0     1       0     1   1001 <span class="built_in">test</span> <span class="variable">$0</span>, %ax</span><br><span class="line">    0     1       0     1   1002 jne  .acquire</span><br><span class="line">    1     1       0     1   1003 mov  <span class="variable">$1</span>, flag</span><br><span class="line">    1     1       1     1   1004 mov  count, %ax</span><br><span class="line">    1     1       2     1   1005 add  <span class="variable">$1</span>, %ax</span><br><span class="line">    1     2       2     1   1006 mov  %ax, count</span><br><span class="line">    0     2       2     1   1007 mov  <span class="variable">$0</span>, flag</span><br><span class="line">    0     2       2     0   1008 sub  <span class="variable">$1</span>, %bx</span><br><span class="line">    0     2       2     0   1009 <span class="built_in">test</span> <span class="variable">$0</span>, %bx</span><br><span class="line">    0     2       2     0   1010 jgt .top</span><br><span class="line">    0     2       2     0   1011 halt</span><br><span class="line">    0     2       0     2   ----- Halt;Switch -----  ----- Halt;Switch -----</span><br><span class="line">    0     2       0     2                            1000 mov  flag, %ax</span><br><span class="line">    0     2       0     2                            1001 <span class="built_in">test</span> <span class="variable">$0</span>, %ax</span><br><span class="line">    0     2       0     2                            1002 jne  .acquire</span><br><span class="line">    1     2       0     2                            1003 mov  <span class="variable">$1</span>, flag</span><br><span class="line">    1     2       2     2                            1004 mov  count, %ax</span><br><span class="line">    1     2       3     2                            1005 add  <span class="variable">$1</span>, %ax</span><br><span class="line">    1     3       3     2                            1006 mov  %ax, count</span><br><span class="line">    0     3       3     2                            1007 mov  <span class="variable">$0</span>, flag</span><br><span class="line">    0     3       3     1                            1008 sub  <span class="variable">$1</span>, %bx</span><br><span class="line">    0     3       3     1                            1009 <span class="built_in">test</span> <span class="variable">$0</span>, %bx</span><br><span class="line">    0     3       3     1                            1010 jgt .top</span><br><span class="line">    0     3       0     1                            1000 mov  flag, %ax</span><br><span class="line">    0     3       0     1                            1001 <span class="built_in">test</span> <span class="variable">$0</span>, %ax</span><br><span class="line">    0     3       0     1                            1002 jne  .acquire</span><br><span class="line">    1     3       0     1                            1003 mov  <span class="variable">$1</span>, flag</span><br><span class="line">    1     3       3     1                            1004 mov  count, %ax</span><br><span class="line">    1     3       4     1                            1005 add  <span class="variable">$1</span>, %ax</span><br><span class="line">    1     4       4     1                            1006 mov  %ax, count</span><br><span class="line">    0     4       4     1                            1007 mov  <span class="variable">$0</span>, flag</span><br><span class="line">    0     4       4     0                            1008 sub  <span class="variable">$1</span>, %bx</span><br><span class="line">    0     4       4     0                            1009 <span class="built_in">test</span> <span class="variable">$0</span>, %bx</span><br><span class="line">    0     4       4     0                            1010 jgt .top</span><br><span class="line">    0     4       4     0                            1011 halt</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>和前面的题目一样，实际就是两个线程分别进行两次累加，可以看到到目前为止，都能够正确完成累加。原因是中断切换线程执行的时候，两个线程都能够完成所有的累加，就不会出现存在竞态条件的情况。</p>
<h3 id="4-1"><a href="#4-1" class="headerlink" title="4."></a>4.</h3><p>这里我让循环为50次</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$./x86.py -p flag.s -R ax,bx -M flag,count -c -a bx=50,bx=50 -i 3</span><br><span class="line">...</span><br><span class="line"> flag count      ax    bx          Thread 0                Thread 1</span><br><span class="line"></span><br><span class="line">    0     0       0     2</span><br><span class="line">    0     0       0     2   1000 mov  flag, %ax</span><br><span class="line">    0     0       0     2   1001 <span class="built_in">test</span> <span class="variable">$0</span>, %ax</span><br><span class="line">    0     0       0     2   1002 jne  .acquire</span><br><span class="line">    1     0       0     2   1003 mov  <span class="variable">$1</span>, flag</span><br><span class="line">    1     0       0     2   1004 mov  count, %ax</span><br><span class="line">    1     0       1     2   1005 add  <span class="variable">$1</span>, %ax</span><br><span class="line">    1     1       1     2   1006 mov  %ax, count</span><br><span class="line">    0     1       1     2   1007 mov  <span class="variable">$0</span>, flag</span><br><span class="line">...</span><br><span class="line">  	1    57      57     1   1006 mov  %ax, count</span><br><span class="line">    0    57      57     1   1007 mov  <span class="variable">$0</span>, flag</span><br><span class="line">    0    57      57     1   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    0    57      57     0   1008 sub  <span class="variable">$1</span>, %bx</span><br><span class="line">    0    57      57     0   1009 <span class="built_in">test</span> <span class="variable">$0</span>, %bx</span><br><span class="line">    0    57      57     0   1010 jgt .top</span><br><span class="line">    0    57      57     0   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    0    57      57     0   1011 halt</span><br></pre></td></tr></table></figure>
<p>你能够看到两个线程循环50次，应该要能够累加100次，但是最后的结果是只累加了57次。此时我们说出现了不确定现象。</p>
<p>由于以flag作为锁，它的加锁和解锁本身没有原子性，所以并不能够起到保护共享资源的作用。所以随着<code>bx</code>增大，<code>i</code>减小，越容易产生不好的结果。反过来<code>bx</code>减小，<code>i</code>增大越趋向于产生确定的好的结果。</p>
<h3 id="5"><a href="#5" class="headerlink" title="5."></a>5.</h3><p>现在我们研究另外一个文件，它是个使用硬件原语<code>test-and-set</code>的指令，详细看看：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> test-and-set.s</span><br><span class="line">.var mutex</span><br><span class="line">.var count</span><br><span class="line"></span><br><span class="line">.main</span><br><span class="line">.top</span><br><span class="line"></span><br><span class="line">.acquire</span><br><span class="line">mov  <span class="variable">$1</span>, %ax</span><br><span class="line">xchg %ax, mutex     <span class="comment"># atomic swap of 1 and mutex</span></span><br><span class="line"><span class="built_in">test</span> <span class="variable">$0</span>, %ax        <span class="comment"># if we get 0 back: lock is free!</span></span><br><span class="line">jne  .acquire       <span class="comment"># if not, try again</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># critical section</span></span><br><span class="line">mov  count, %ax     <span class="comment"># get the value at the address</span></span><br><span class="line">add  <span class="variable">$1</span>, %ax        <span class="comment"># increment it</span></span><br><span class="line">mov  %ax, count     <span class="comment"># store it back</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># release lock</span></span><br><span class="line">mov  <span class="variable">$0</span>, mutex</span><br><span class="line"></span><br><span class="line"><span class="comment"># see if we&#x27;re still looping</span></span><br><span class="line">sub  <span class="variable">$1</span>, %bx</span><br><span class="line"><span class="built_in">test</span> <span class="variable">$0</span>, %bx</span><br><span class="line">jgt .top</span><br><span class="line"></span><br><span class="line">halt</span><br></pre></td></tr></table></figure>
<p>同样针对上面的汇编代码我们写出c语言版本</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">char</span> <span class="type">mutex_t</span>;</span><br><span class="line"><span class="type">mutex_t</span> mutex;</span><br><span class="line"><span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> i = n;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">/* 等待锁空闲，如果有空闲锁就上锁 */</span></span><br><span class="line">        <span class="keyword">while</span> (test_and_set(&amp;mutex, <span class="number">0x1</span>) != <span class="number">0x0</span>)</span><br><span class="line">            ; <span class="comment">// spin</span></span><br><span class="line">        <span class="comment">/* 临界区 */</span></span><br><span class="line">        count++;</span><br><span class="line">        <span class="comment">/* 解锁 */</span></span><br><span class="line">        mutex = <span class="number">0x0</span>;</span><br><span class="line">        i--;</span><br><span class="line">    &#125; <span class="keyword">while</span> (i &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="comment">/* halt */</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中获取锁部分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 等待锁空闲，如果有空闲锁就上锁 */</span></span><br><span class="line"><span class="keyword">while</span> (test_and_set(&amp;mutex, <span class="number">0x1</span>) != <span class="number">0x0</span>)</span><br><span class="line">    ; <span class="comment">// spin</span></span><br><span class="line">=&gt;</span><br><span class="line">.acquire</span><br><span class="line">mov  $<span class="number">1</span>, %ax</span><br><span class="line">xchg %ax, mutex     <span class="meta"># atomic swap of 1 and mutex</span></span><br><span class="line">test $<span class="number">0</span>, %ax        <span class="meta"># <span class="keyword">if</span> we get 0 back: lock is free!</span></span><br><span class="line">jne  .acquire       <span class="meta"># <span class="keyword">if</span> not, try again</span></span><br></pre></td></tr></table></figure>
<p>释放锁部分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 解锁 */</span></span><br><span class="line">mutex = <span class="number">0x0</span>;</span><br><span class="line">=&gt;</span><br><span class="line">mov  $<span class="number">0</span>, mutex</span><br></pre></td></tr></table></figure>
<h3 id="6"><a href="#6" class="headerlink" title="6."></a>6.</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ ./x86.py -p test-and-set.s -i 3 -a bx=50,bx=50 -M mutex,count -R ax,bx -c</span><br><span class="line">...</span><br><span class="line">mutex count      ax    bx          Thread 0                Thread 1</span><br><span class="line"></span><br><span class="line">    0     0       0    50</span><br><span class="line">    0     0       1    50   1000 mov  <span class="variable">$1</span>, %ax</span><br><span class="line">    1     0       0    50   1001 xchg %ax, mutex</span><br><span class="line">    1     0       0    50   1002 <span class="built_in">test</span> <span class="variable">$0</span>, %ax</span><br><span class="line">    1     0       0    50   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    1     0       1    50                            1000 mov  <span class="variable">$1</span>, %ax</span><br><span class="line">    1     0       1    50                            1001 xchg %ax, mutex</span><br><span class="line">    1     0       1    50                            1002 <span class="built_in">test</span> <span class="variable">$0</span>, %ax</span><br><span class="line">    1     0       0    50   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">... </span><br><span class="line">   	0   100     100     0                            1008 sub  <span class="variable">$1</span>, %bx</span><br><span class="line">    0   100     100     0   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    0   100     100     0                            1009 <span class="built_in">test</span> <span class="variable">$0</span>, %bx</span><br><span class="line">    0   100     100     0                            1010 jgt .top</span><br><span class="line">    0   100     100     0                            1011 halt</span><br></pre></td></tr></table></figure>
<p>可以看到在这种<code>test-and-set</code>的硬件原语支持下，能够保证原子性。所以最后计算的结果能够满足预期。但是可以从上面的代码中的看出，虽然保证了加锁的原子性，进而控制了了每次只能有一个线程在临界区。但是，由于当线程没有抢占到锁，就会在while中自旋等待，倘若拥有锁定的线程迟迟不释放锁，其他大量的线程就可能都处于自选等待的状态。而如果线程间调度采用的是类似轮转这样的算法，那么就会有大量的CPU资源用来自选。这种自选显然不是我们想要的，因此由于分时共享CPU的存在，CPU的使用率虽然比较高，但是做的有用功却不是很高，大部分时间在做自选等待。</p>
<p>现在考虑如何量化这样的CPU使用率的描述。就比如上面的示例代码两个线程一共做了100次累加，每次累加只有下面3条指令是经行累加的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># critical section</span><br><span class="line">mov  count, %ax     # get the value at the address</span><br><span class="line">add  $1, %ax        # increment it</span><br><span class="line">mov  %ax, count     # store it back</span><br></pre></td></tr></table></figure>
<p>因此也就只有3*100 = 300条指令做有用功，剩下的通通是无用功。可以统计上面的计算共有2010行。由于整个计算过程CPU都处于工作状态。因此使用率100%。但是有效使用率仅有300/2010 = 14.93%</p>
<h3 id="7"><a href="#7" class="headerlink" title="7."></a>7.</h3><p>首先我们需要通过增加<code>-P</code>属性来规定执行的顺序。例如：<code>-P 1100111000111000111000</code>就会依次按照t1，t1，t0，t0，t1，…，t0，t0，t0的顺序执行线程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ ./x86.py -p test-and-set.s -i 10 -R ax,bx -M mutex,count -a bx=5 -P 1100111000111000111000 -c</span><br><span class="line">...</span><br><span class="line">mutex count      ax    bx          Thread 0                Thread 1</span><br><span class="line"></span><br><span class="line">    0     0       0     5</span><br><span class="line">    0     0       1     5                            1000 mov  <span class="variable">$1</span>, %ax</span><br><span class="line">    1     0       0     5                            1001 xchg %ax, mutex</span><br><span class="line">    1     0       0     5   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    1     0       1     5   1000 mov  <span class="variable">$1</span>, %ax</span><br><span class="line">    1     0       1     5   1001 xchg %ax, mutex</span><br><span class="line">    1     0       0     5   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line">    1     0       0     5                            1002 <span class="built_in">test</span> <span class="variable">$0</span>, %ax</span><br><span class="line">    1     0       0     5                            1003 jne  .acquire</span><br><span class="line">...</span><br><span class="line">    1    10      10     1   1006 mov  %ax, count</span><br><span class="line">    0    10      10     1   1007 mov  <span class="variable">$0</span>, mutex</span><br><span class="line">    0    10      10     0   1008 sub  <span class="variable">$1</span>, %bx</span><br><span class="line">    0    10      10     0   1009 <span class="built_in">test</span> <span class="variable">$0</span>, %bx</span><br><span class="line">    0    10      10     0   1010 jgt .top</span><br><span class="line">    0    10      10     0   1011 halt</span><br></pre></td></tr></table></figure>
<p>可以看到最后结果是正确的，由于上面的获取锁过程是具有原子性的，也就是说每一次只能有一个线程执行成功(成功把flag从0变成1)获得锁。因此也就保证了正确性。</p>
<h2 id="第30章"><a href="#第30章" class="headerlink" title="第30章"></a>第30章</h2><p>由于第30章中文版课本上没有题目，因此在这里放出英文课本原题。</p>
<h3 id="1-2"><a href="#1-2" class="headerlink" title="1."></a>1.</h3><p><img src="/2022/05/19/OS-thread-homework/image-20220516082241930.png" alt="image-20220516082241930"></p>
<p>这个题目要我们专注于文件<code>main-two-cvs-while.c</code>。首先需要先了解代码的含义，理解代码运行会发生什么。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src: main-two-cvs-while.c */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;common.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;common_threads.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pc-header.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是用于生产者消费者的信号量</span></span><br><span class="line"><span class="comment">// empty 用于通知生产者复工</span></span><br><span class="line"><span class="comment">// fill  用于通知消费者消费</span></span><br><span class="line"><span class="comment">// m     锁</span></span><br><span class="line"><span class="type">pthread_cond_t</span> empty  = PTHREAD_COND_INITIALIZER;</span><br><span class="line"><span class="type">pthread_cond_t</span> fill   = PTHREAD_COND_INITIALIZER;</span><br><span class="line"><span class="type">pthread_mutex_t</span> m     = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;main-header.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 填充函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">do_fill</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">    <span class="comment">// 确保在这个函数使用前buffer[fill_ptr]是空的</span></span><br><span class="line">    <span class="comment">// 否则打印错误讯息</span></span><br><span class="line">    ensure(buffer[fill_ptr] == EMPTY, <span class="string">&quot;error: tried to fill a non-empty buffer&quot;</span>);</span><br><span class="line">    <span class="comment">// 填充缓冲区特定位置</span></span><br><span class="line">    buffer[fill_ptr] = value;</span><br><span class="line">    <span class="comment">// 填充指针指向下一位置</span></span><br><span class="line">    fill_ptr = (fill_ptr + <span class="number">1</span>) % max;</span><br><span class="line">    <span class="comment">// 已经填充数量加一</span></span><br><span class="line">    num_full++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取函数</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">do_get</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取特定位置的值</span></span><br><span class="line">    <span class="type">int</span> tmp = buffer[use_ptr];</span><br><span class="line">    <span class="comment">// 确保缓冲区有值</span></span><br><span class="line">    <span class="comment">// 否则打印错误讯息</span></span><br><span class="line">    ensure(tmp != EMPTY, <span class="string">&quot;error: tried to get an empty buffer&quot;</span>);</span><br><span class="line">    <span class="comment">// 取完商品把这个位置置空</span></span><br><span class="line">    buffer[use_ptr] = EMPTY;</span><br><span class="line">    <span class="comment">// 使用指针指向下一位置</span></span><br><span class="line">    use_ptr = (use_ptr + <span class="number">1</span>) % max;</span><br><span class="line">    <span class="comment">// 已经填充数量减一</span></span><br><span class="line">    num_full--;</span><br><span class="line">    <span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生产者函数</span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">producer</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    <span class="comment">// 根据arg所指的数值设置生产者的id</span></span><br><span class="line">    <span class="type">int</span> id = (<span class="type">int</span>) arg;</span><br><span class="line">    <span class="comment">// 确保每一个生产者能够生产自己专属的值(与id关联)</span></span><br><span class="line">    <span class="type">int</span> base = id * loops;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; loops; i++) &#123;   p0;	<span class="comment">// 循环生产商品</span></span><br><span class="line">        Mutex_lock(&amp;m);             p1;	<span class="comment">// 获取锁</span></span><br><span class="line">        <span class="keyword">while</span> (num_full == max) &#123;   p2;	<span class="comment">// 如果货架满了</span></span><br><span class="line">            Cond_wait(&amp;empty, &amp;m);  p3;	<span class="comment">// 则睡眠等待货架再次为空时复工</span></span><br><span class="line">        &#125;</span><br><span class="line">        do_fill(base + i);          p4;	<span class="comment">// 进行一次货架填充</span></span><br><span class="line">        Cond_signal(&amp;fill);         p5;	<span class="comment">// 通知消费者可消费</span></span><br><span class="line">        Mutex_unlock(&amp;m);           p6;	<span class="comment">// 释放锁</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">consumer</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    <span class="comment">// 消费者根据arg产生唯一id</span></span><br><span class="line">    <span class="type">int</span> id = (<span class="type">int</span>) arg;					</span><br><span class="line">    <span class="type">int</span> tmp = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> consumed_count = <span class="number">0</span>;			   <span class="comment">// 消费数量</span></span><br><span class="line">    <span class="keyword">while</span> (tmp != END_OF_STREAM) &#123; c0; <span class="comment">// 循环直到生产商品流的最后元素</span></span><br><span class="line">        Mutex_lock(&amp;m);            c1; <span class="comment">// 获取锁</span></span><br><span class="line">        <span class="keyword">while</span> (num_full == <span class="number">0</span>) &#123;    c2; <span class="comment">// 如果货架空了</span></span><br><span class="line">            Cond_wait(&amp;fill, &amp;m);  c3; <span class="comment">// 等待生产者填充货架</span></span><br><span class="line">        &#125;</span><br><span class="line">        tmp = do_get();            c4; <span class="comment">// 获取货物</span></span><br><span class="line">        Cond_signal(&amp;empty);       c5; <span class="comment">// </span></span><br><span class="line">        Mutex_unlock(&amp;m);          c6; <span class="comment">// 释放锁</span></span><br><span class="line">        consumed_count++;			   <span class="comment">// 消费数量加一</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回consumer_count-1是因为END_OF_STREAM并不是有效商品</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span> *) (<span class="type">long</span> <span class="type">long</span>) (consumed_count - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置控制信号</span></span><br><span class="line"><span class="type">pthread_cond_t</span> *fill_cv = &amp;fill;</span><br><span class="line"><span class="type">pthread_cond_t</span> *empty_cv = &amp;empty;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 所有代码使用这个文件里的东西</span></span><br><span class="line"><span class="comment">// 包括主函数等启动问题程序</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;main-common.c&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>对上面的代码我们做出了解析，如注释所示。我们的生产者会调用<code>do_fill</code>进行生产活动，一次只生产一个货物到空货架上。消费者会调用<code>do_get</code>获取货物，一次只获得一个商品。货架是一个数组，上面依次存取商品，由<code>fill_ptr</code>指明放入位置，由<code>use_ptr</code>知名从哪个位置取商品。</p>
<h3 id="2-2"><a href="#2-2" class="headerlink" title="2."></a>2.</h3><p><img src="/2022/05/19/OS-thread-homework/image-20220516085555854.png" alt="image-20220516085555854"></p>
<p>运行一个生产者一个消费者程序，然后让生产者生产一些特定的值。一开始我们只是使用一个长度大小只有1的buffer，然后慢慢增长它。当货架增大，程序代码会做和行为？你认为<code>num_full</code>会随着buffer的容量变大有什么不同（例如可以设成-<code>l 100</code>），当你改变消费者字符串，从默认的不睡眠到<code>-C 0,0,0,0,0,0,1</code>会发生什么？</p>
<p>这是一个项目程序，我们应该先编译他们：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh&gt; make</span><br></pre></td></tr></table></figure>
<p>编译完成生成了几个可执行的程序，现在我们让buffer长度为1，然后仅仅看看一个生产者和一个消费者的情况</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">puitar@ubuntu:~/Desktop/ostep-homework/threads-cv</span><br><span class="line">$ ./main-two-cvs-while -p 1 -c1 -m 1 -v</span><br><span class="line"> NF         P0 C0 </span><br><span class="line">  0 [*--- ]    c0</span><br><span class="line">  0 [*--- ] p0</span><br><span class="line">  0 [*--- ]    c1</span><br><span class="line">  0 [*--- ]    c2</span><br><span class="line">  0 [*--- ] p1</span><br><span class="line">  1 [*  0 ] p4</span><br><span class="line">  1 [*  0 ] p5</span><br><span class="line">  1 [*  0 ] p6</span><br><span class="line">  1 [*  0 ]    c3</span><br><span class="line">  0 [*--- ]    c4</span><br><span class="line">  0 [*--- ]    c5</span><br><span class="line">  1 [*EOS ] [main: added end-of-stream marker]</span><br><span class="line">  1 [*EOS ]    c6</span><br><span class="line">  1 [*EOS ]    c0</span><br><span class="line">  1 [*EOS ]    c1</span><br><span class="line">  0 [*--- ]    c4</span><br><span class="line">  0 [*--- ]    c5</span><br><span class="line">  0 [*--- ]    c6</span><br><span class="line"></span><br><span class="line">Consumer consumption:</span><br><span class="line">  C0 -&gt; 1</span><br></pre></td></tr></table></figure>
<p>上面的数码做了一件事：[]中放的是buffer的内容，再往左是buffer的<code>full_num</code>。然后是对应的生产者消费者执行的步骤。（具体请见上面c代码）首先消费者执行c0，然后是消费者执行p0。然后消费者执行c1获取锁。然后while判断货架为空准备进入等待并释放锁。然后生产者获取锁，while判断货架为空跳过等待进行生产，然后唤醒消费者并释放锁。然后消费者苏醒获取锁，进行消费。此时以达到生产线最后元素（EOS）。然后消费者退出循环并返回。最后我们可以看到消费者C0消费了一个商品。上面过程没有出现什么问题。</p>
<p>接下来我们增大buffer尺寸。比如加到10</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">puitar@ubuntu:~/Desktop/ostep-homework/threads-cv</span><br><span class="line">$ ./main-two-cvs-while -p 1 -c1 -m 10 -v</span><br><span class="line"> NF                                                      P0 C0 </span><br><span class="line">  0 [*---  ---  ---  ---  ---  ---  ---  ---  ---  --- ]    c0</span><br><span class="line">  0 [*---  ---  ---  ---  ---  ---  ---  ---  ---  --- ] p0</span><br><span class="line">  0 [*---  ---  ---  ---  ---  ---  ---  ---  ---  --- ] p1</span><br><span class="line">  1 [u  0 f---  ---  ---  ---  ---  ---  ---  ---  --- ] p4</span><br><span class="line">  1 [u  0 f---  ---  ---  ---  ---  ---  ---  ---  --- ] p5</span><br><span class="line">  1 [u  0 f---  ---  ---  ---  ---  ---  ---  ---  --- ] p6</span><br><span class="line">  1 [u  0 f---  ---  ---  ---  ---  ---  ---  ---  --- ]    c1</span><br><span class="line">  0 [ --- *---  ---  ---  ---  ---  ---  ---  ---  --- ]    c4</span><br><span class="line">  0 [ --- *---  ---  ---  ---  ---  ---  ---  ---  --- ]    c5</span><br><span class="line">  1 [ --- uEOS f---  ---  ---  ---  ---  ---  ---  --- ] [main: added end-of-stream marker]</span><br><span class="line">  1 [ --- uEOS f---  ---  ---  ---  ---  ---  ---  --- ]    c6</span><br><span class="line">  1 [ --- uEOS f---  ---  ---  ---  ---  ---  ---  --- ]    c0</span><br><span class="line">  1 [ --- uEOS f---  ---  ---  ---  ---  ---  ---  --- ]    c1</span><br><span class="line">  0 [ ---  --- *---  ---  ---  ---  ---  ---  ---  --- ]    c4</span><br><span class="line">  0 [ ---  --- *---  ---  ---  ---  ---  ---  ---  --- ]    c5</span><br><span class="line">  0 [ ---  --- *---  ---  ---  ---  ---  ---  ---  --- ]    c6</span><br><span class="line"></span><br><span class="line">Consumer consumption:</span><br><span class="line">  C0 -&gt; 1</span><br></pre></td></tr></table></figure>
<p>可以看到<code>-l</code>不发生变化，实际上和前面差不多，都没有什么问题。</p>
<p>然后我们现在增加生产次数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">puitar@ubuntu:~/Desktop/ostep-homework/threads-cv$ ./main-two-cvs-while -p 1 -c1 -m 10 -l 100  -v</span><br><span class="line"> NF                                                      P0 C0 </span><br><span class="line">  0 [*---  ---  ---  ---  ---  ---  ---  ---  ---  --- ] p0</span><br><span class="line">  0 [*---  ---  ---  ---  ---  ---  ---  ---  ---  --- ]    c0</span><br><span class="line">  0 [*---  ---  ---  ---  ---  ---  ---  ---  ---  --- ] p1</span><br><span class="line">  1 [u  0 f---  ---  ---  ---  ---  ---  ---  ---  --- ] p4</span><br><span class="line">  1 [u  0 f---  ---  ---  ---  ---  ---  ---  ---  --- ] p5</span><br><span class="line">  1 [u  0 f---  ---  ---  ---  ---  ---  ---  ---  --- ] p6</span><br><span class="line">...</span><br><span class="line">  1 [f---  ---  ---  ---  ---  ---  ---  ---  --- u 99 ] p5</span><br><span class="line">  1 [f---  ---  ---  ---  ---  ---  ---  ---  --- u 99 ] p6</span><br><span class="line">  1 [f---  ---  ---  ---  ---  ---  ---  ---  --- u 99 ]    c1</span><br><span class="line">  0 [*---  ---  ---  ---  ---  ---  ---  ---  ---  --- ]    c4</span><br><span class="line">  0 [*---  ---  ---  ---  ---  ---  ---  ---  ---  --- ]    c5</span><br><span class="line">  1 [uEOS f---  ---  ---  ---  ---  ---  ---  ---  --- ] [main: added end-of-stream marker]</span><br><span class="line">  1 [uEOS f---  ---  ---  ---  ---  ---  ---  ---  --- ]    c6</span><br><span class="line">  1 [uEOS f---  ---  ---  ---  ---  ---  ---  ---  --- ]    c0</span><br><span class="line">  1 [uEOS f---  ---  ---  ---  ---  ---  ---  ---  --- ]    c1</span><br><span class="line">  0 [ --- *---  ---  ---  ---  ---  ---  ---  ---  --- ]    c4</span><br><span class="line">  0 [ --- *---  ---  ---  ---  ---  ---  ---  ---  --- ]    c5</span><br><span class="line">  0 [ --- *---  ---  ---  ---  ---  ---  ---  ---  --- ]    c6</span><br><span class="line"></span><br><span class="line">Consumer consumption:</span><br><span class="line">  C0 -&gt; 100</span><br></pre></td></tr></table></figure>
<p>可以看到消费者都能够正常获得商品。</p>
<p>现在改变消费者睡眠字符串</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">puitar@ubuntu:~/Desktop/ostep-homework/threads-cv$ ./main-two-cvs-while -p 1 -c1 -m 10 -l 100  -v</span><br><span class="line"> NF                                                      P0 C0 </span><br><span class="line">  0 [*---  ---  ---  ---  ---  ---  ---  ---  ---  --- ] p0</span><br><span class="line">  0 [*---  ---  ---  ---  ---  ---  ---  ---  ---  --- ]    c0</span><br><span class="line">  0 [*---  ---  ---  ---  ---  ---  ---  ---  ---  --- ] p1</span><br><span class="line">  1 [u  0 f---  ---  ---  ---  ---  ---  ---  ---  --- ] p4</span><br><span class="line">  1 [u  0 f---  ---  ---  ---  ---  ---  ---  ---  --- ] p5</span><br><span class="line">  1 [u  0 f---  ---  ---  ---  ---  ---  ---  ---  --- ] p6</span><br><span class="line">  1 [u  0 f---  ---  ---  ---  ---  ---  ---  ---  --- ]    c1</span><br><span class="line">  0 [ --- *---  ---  ---  ---  ---  ---  ---  ---  --- ]    c4</span><br><span class="line">  0 [ --- *---  ---  ---  ---  ---  ---  ---  ---  --- ] p0</span><br><span class="line">  0 [ --- *---  ---  ---  ---  ---  ---  ---  ---  --- ]    c5</span><br><span class="line">  0 [ --- *---  ---  ---  ---  ---  ---  ---  ---  --- ]    c6</span><br><span class="line">  0 [ --- *---  ---  ---  ---  ---  ---  ---  ---  --- ] p1</span><br><span class="line">  0 [ --- *---  ---  ---  ---  ---  ---  ---  ---  --- ]    c0</span><br><span class="line">  1 [ --- u  1 f---  ---  ---  ---  ---  ---  ---  --- ] p4</span><br><span class="line">  1 [ --- u  1 f---  ---  ---  ---  ---  ---  ---  --- ] p5</span><br><span class="line">...</span><br><span class="line"> 0 [ ---  ---  ---  ---  --- *---  ---  ---  ---  --- ] p1</span><br><span class="line">  1 [ ---  ---  ---  ---  --- u 25 f---  ---  ---  --- ] p4</span><br><span class="line">  1 [ ---  ---  ---  ---  --- u 25 f---  ---  ---  --- ]    c0</span><br><span class="line">  1 [ ---  ---  ---  ---  --- u 25 f---  ---  ---  --- ] p5</span><br><span class="line">  1 [ ---  ---  ---  ---  --- u 25 f---  ---  ---  --- ] p6</span><br><span class="line">  1 [ ---  ---  ---  ---  --- u 25 f---  ---  ---  --- ]    c1</span><br><span class="line">  1 [ ---  ---  ---  ---  --- u 25 f---  ---  ---  --- ] p0</span><br><span class="line">  0 [ ---  ---  ---  ---  ---  --- *---  ---  ---  --- ]    c4</span><br><span class="line">  0 [ ---  ---  ---  ---  ---  --- *---  ---  ---  --- ]    c5</span><br><span class="line">  0 [ ---  ---  ---  ---  ---  --- *---  ---  ---  --- ]    c6</span><br><span class="line">  0 [ ---  ---  ---  ---  ---  --- *---  ---  ---  --- ] p1</span><br><span class="line">  1 [ ---  ---  ---  ---  ---  --- u 26 f---  ---  --- ] p4</span><br><span class="line">  1 [ ---  ---  ---  ---  ---  --- u 26 f---  ---  --- ]    c0</span><br><span class="line">  1 [ ---  ---  ---  ---  ---  --- u 26 f---  ---  --- ] p5</span><br><span class="line">  1 [ ---  ---  ---  ---  ---  --- u 26 f---  ---  --- ] p6</span><br><span class="line">  1 [ ---  ---  ---  ---  ---  --- u 26 f---  ---  --- ] p0</span><br><span class="line">  1 [ ---  ---  ---  ---  ---  --- u 26 f---  ---  --- ]    c1</span><br><span class="line">  0 [ ---  ---  ---  ---  ---  ---  --- *---  ---  --- ]    c4</span><br><span class="line">  0 [ ---  ---  ---  ---  ---  ---  --- *---  ---  --- ]    c5</span><br><span class="line">  0 [ ---  ---  ---  ---  ---  ---  --- *---  ---  --- ]    c6</span><br><span class="line">  0 [ ---  ---  ---  ---  ---  ---  --- *---  ---  --- ] p1</span><br><span class="line">  0 [ ---  ---  ---  ---  ---  ---  --- *---  ---  --- ]    c0</span><br><span class="line">  1 [ ---  ---  ---  ---  ---  ---  --- u 27 f---  --- ] p4</span><br><span class="line">  1 [ ---  ---  ---  ---  ---  ---  --- u 27 f---  --- ] p5</span><br><span class="line">  1 [ ---  ---  ---  ---  ---  ---  --- u 27 f---  --- ] p6</span><br><span class="line">  1 [ ---  ---  ---  ---  ---  ---  --- u 27 f---  --- ]    c1</span><br><span class="line">  1 [ ---  ---  ---  ---  ---  ---  --- u 27 f---  --- ] p0</span><br><span class="line">  0 [ ---  ---  ---  ---  ---  ---  ---  --- *---  --- ]    c4</span><br><span class="line">...</span><br><span class="line">  9 [f--- u  1    2    3    4    5    6    7    8    9 ] p0</span><br><span class="line">  9 [f--- u  1    2    3    4    5    6    7    8    9 ] p1</span><br><span class="line"> 10 [  10 *  1    2    3    4    5    6    7    8    9 ] p4</span><br><span class="line"> 10 [  10 *  1    2    3    4    5    6    7    8    9 ] p5</span><br><span class="line"> 10 [  10 *  1    2    3    4    5    6    7    8    9 ] p6</span><br><span class="line"> 10 [  10 *  1    2    3    4    5    6    7    8    9 ] p0</span><br><span class="line"> 10 [  10 *  1    2    3    4    5    6    7    8    9 ] p1</span><br><span class="line"> 10 [  10 *  1    2    3    4    5    6    7    8    9 ] p2</span><br><span class="line"> 10 [  10 *  1    2    3    4    5    6    7    8    9 ]    c0</span><br><span class="line"> 10 [  10 *  1    2    3    4    5    6    7    8    9 ]    c1</span><br><span class="line">  9 [  10 f--- u  2    3    4    5    6    7    8    9 ]    c4</span><br><span class="line">  9 [  10 f--- u  2    3    4    5    6    7    8    9 ]    c5</span><br><span class="line">  9 [  10 f--- u  2    3    4    5    6    7    8    9 ]    c6</span><br><span class="line">  9 [  10 f--- u  2    3    4    5    6    7    8    9 ] p3</span><br><span class="line">...</span><br><span class="line">  1 [uEOS f---  ---  ---  ---  ---  ---  ---  ---  --- ]    c0</span><br><span class="line">  1 [uEOS f---  ---  ---  ---  ---  ---  ---  ---  --- ]    c1</span><br><span class="line">  0 [ --- *---  ---  ---  ---  ---  ---  ---  ---  --- ]    c4</span><br><span class="line">  0 [ --- *---  ---  ---  ---  ---  ---  ---  ---  --- ]    c5</span><br><span class="line">  0 [ --- *---  ---  ---  ---  ---  ---  ---  ---  --- ]    c6</span><br><span class="line"></span><br><span class="line">Consumer consumption:</span><br><span class="line">  C0 -&gt; 100</span><br></pre></td></tr></table></figure>
<p>看到上面的代码，生产f总是在使用u之前。</p>
<p>同时消费者总是等到缓冲区满了才开始消费。然后消费一个就通知生产者生产直到生产完毕。</p>
<p>此时一切生产消费活动都处于正常状态。</p>
<h3 id="4-2"><a href="#4-2" class="headerlink" title="4."></a>4.</h3><p><img src="/2022/05/19/OS-thread-homework/image-20220516100021157.png" alt="image-20220516100021157"></p>
<p>如果只有一个生产者，三个消费者，只有一个单一入口的buffer，每个消费者在c3指令执行的时候入睡要一秒钟（-C 0,0,0,1,0,0,0）</p>
<p>我们输入指令看看情况发生了什么？</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">puitar@ubuntu:~/Desktop/ostep-homework/threads-cv</span><br><span class="line">$ ./main-two-cvs-while -p 1 -c 3 -m 1 -C 0,0,0,1,0,0,0:0,0,0,1,0,0,0:0,0,0,1,0,0,0 -l 10 -v -t</span><br><span class="line"> NF         P0 C0 C1 C2 </span><br><span class="line">  0 [*--- ]    c0</span><br><span class="line">  0 [*--- ] p0</span><br><span class="line">  0 [*--- ]       c0</span><br><span class="line">  0 [*--- ]          c0</span><br><span class="line">  0 [*--- ]    c1</span><br><span class="line">  0 [*--- ]    c2</span><br><span class="line">  0 [*--- ] p1</span><br><span class="line">  1 [*  0 ] p4</span><br><span class="line">  1 [*  0 ] p5</span><br><span class="line">  1 [*  0 ] p6</span><br><span class="line">  1 [*  0 ]       c1</span><br><span class="line">...</span><br><span class="line">Consumer consumption:</span><br><span class="line">  C0 -&gt; 0</span><br><span class="line">  C1 -&gt; 10</span><br><span class="line">  C2 -&gt; 0</span><br><span class="line"></span><br><span class="line">Total time: 13.07 seconds</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Consumer consumption:</span><br><span class="line">  C0 -&gt; 9</span><br><span class="line">  C1 -&gt; 0</span><br><span class="line">  C2 -&gt; 1</span><br><span class="line"></span><br><span class="line">Total time: 12.08 seconds</span><br></pre></td></tr></table></figure>
<p>不同次运行同样的命令，每次的运行时间不一致。但至少10s，因为消费者会取出10个数据。每取一个都会有1s的休眠。</p>
<p>可以看到上面的代码能够保证生产10个消费10个，但是存在消费者会被饿死的情况。</p>
<h3 id="8"><a href="#8" class="headerlink" title="8."></a>8.</h3><p><img src="/2022/05/19/OS-thread-homework/image-20220516101427280.png" alt="image-20220516101427280"></p>
<p>现在看看<code>main-one-cv-while.c</code>，现在我们要写一个睡眠字符串，在只有一个生产者和一个消费者和一个缓冲区只有1大小的情况下产生问题。</p>
<p>一个生产者一个消费者不会产生什么问题，因为通信的只有生产者和消费者。但是如果出现两个生产者或者两个消费者的时候，一个条件变量就会不清楚通知的是生产者还是消费者。</p>
<h3 id="9"><a href="#9" class="headerlink" title="9."></a>9.</h3><p><img src="/2022/05/19/OS-thread-homework/image-20220516103344533.png" alt="image-20220516103344533"></p>
<p>这个问题是课本257页表格表示的只有一个条件变量的问题。因为条件变量只有一个，所以所以可能存在一个消费者消费完试图唤醒生产者，但是不是唤醒生产者而是唤醒另外一个消费者，最终造成发出信号的消费者睡着，生产者没有醒过来，另外一个消费者醒过来发现没有东西消费，然后又睡着的情况。最终三个人都睡着了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生产者</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; loops; i++) &#123;   p0;	<span class="comment">// 循环生产商品</span></span><br><span class="line">        Mutex_lock(&amp;m);             p1;	<span class="comment">// 获取锁</span></span><br><span class="line">        <span class="keyword">while</span> (num_full == max) &#123;   p2;	<span class="comment">// 如果货架满了</span></span><br><span class="line">            Cond_wait(&amp;empty, &amp;m);  p3;	<span class="comment">// 则睡眠等待货架再次为空时复工</span></span><br><span class="line">        &#125;</span><br><span class="line">        do_fill(base + i);          p4;	<span class="comment">// 进行一次货架填充</span></span><br><span class="line">        Cond_signal(&amp;fill);         p5;	<span class="comment">// 通知消费者可消费</span></span><br><span class="line">        Mutex_unlock(&amp;m);           p6;	<span class="comment">// 释放锁</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 消费者</span></span><br><span class="line"><span class="keyword">while</span> (tmp != END_OF_STREAM) &#123; c0; <span class="comment">// 循环直到生产商品流的最后元素</span></span><br><span class="line">        Mutex_lock(&amp;m);            c1; <span class="comment">// 获取锁</span></span><br><span class="line">        <span class="keyword">while</span> (num_full == <span class="number">0</span>) &#123;    c2; <span class="comment">// 如果货架空了</span></span><br><span class="line">            Cond_wait(&amp;fill, &amp;m);  c3; <span class="comment">// 等待生产者填充货架</span></span><br><span class="line">        &#125;</span><br><span class="line">        tmp = do_get();            c4; <span class="comment">// 获取货物</span></span><br><span class="line">        Cond_signal(&amp;empty);       c5; <span class="comment">// </span></span><br><span class="line">        Mutex_unlock(&amp;m);          c6; <span class="comment">// 释放锁</span></span><br></pre></td></tr></table></figure>
<p>我们可以看到p3是进行苏醒的，我们让它睡久一点，就能够触发问题了。比如这里我们让他睡五秒。</p>
<p>得到结果如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">puitar@ubuntu:~/Desktop/ostep-homework/threads-cv</span><br><span class="line">$ ./main-one-cv-while -m 1 -l 5 -c 2 -p 1 -P 0,0,0,10,0,0,0 -v -t</span><br><span class="line"> NF         P0 C0 C1 </span><br><span class="line">  0 [*--- ]       c0</span><br><span class="line">  0 [*--- ] p0</span><br><span class="line">  0 [*--- ]    c0</span><br><span class="line">  0 [*--- ] p1</span><br><span class="line">  1 [*  0 ] p4</span><br><span class="line">...</span><br><span class="line">  0 [*--- ]       c5</span><br><span class="line">  0 [*--- ]       c6</span><br><span class="line"></span><br><span class="line">Consumer consumption:</span><br><span class="line">  C0 -&gt; 5</span><br><span class="line">  C1 -&gt; 0</span><br></pre></td></tr></table></figure>
<p><img src="/2022/05/19/OS-thread-homework/image-20220516105426143.png" alt="image-20220516105426143"></p>
<p>可以看到上面蓝色框框的部分C0消费完，不是唤醒P0，而是唤醒C1。</p>
<p>但是由于它编写的调度器总会在所有程序睡眠后调用生产者进行生产。所以可以看到蓝色框框下面又出现了生产者进行生产。但是实际上如果它的调度程序不这么智慧的话，三个线程都会进入睡眠状态。</p>
<h3 id="10"><a href="#10" class="headerlink" title="10."></a>10.</h3><p><img src="/2022/05/19/OS-thread-homework/image-20220516105828890.png" alt="image-20220516105828890"></p>
<p>这个题目要我们运行<code>main-two-cvs-if.c</code>文件。这个文件对等待函数是用<code>if</code>，也就是说仅仅进行一次判定。要我们考虑一个生产者一个消费者的情况，然后增加消费者的数量。试图产生问题。</p>
<p>我们说一个生产者一个消费者是不会有任何问题的。</p>
<p>但是如果有一个消费者或者以上，那么问题就出现了。这个问题其实就是书本255页介绍的问题。就是说只是进行一次等待判断，但是在两个消费者的时候，可能一个消费者判断有货物可取，然后再在它取之前发生中断，然后另外一个消费者也看到了这个货物，然后它一口气取完了。然后前面一个消费者还蒙在鼓里，以为自己还有货物，实际上已经没有货物了。</p>
<p>所以我们在其中一个消费者的去货物之前让它睡久一点就好，可以看到到c4是去货物所以试着构造这样的字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-C 0,0,0,0,5,0,0:0,0,0,0,0,0,0</span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">puitar@ubuntu:~/Desktop/ostep-homework/threads-cv</span><br><span class="line">$ ./main-two-cvs-if -m 1 -l 5 -c 2 -p 1 -C 0,0,0,0,5,0,0:0,0,0,0,0,0,0 -v -t</span><br><span class="line"> NF        P0 C0 C1 </span><br><span class="line">  0 [*--- ]    c0</span><br><span class="line">  0 [*--- ] p0</span><br><span class="line">  0 [*--- ]    c1</span><br><span class="line">  0 [*--- ]       c0</span><br><span class="line">  0 [*--- ]    c2</span><br><span class="line">  0 [*--- ] p1</span><br><span class="line">  1 [*  0 ] p4</span><br><span class="line">  1 [*  0 ] p5</span><br><span class="line">  1 [*  0 ] p6</span><br><span class="line">  1 [*  0 ]       c1</span><br><span class="line">  1 [*  0 ] p0</span><br><span class="line">  0 [*--- ]       c4</span><br><span class="line">  0 [*--- ]       c5</span><br><span class="line">  0 [*--- ]       c6</span><br><span class="line">  0 [*--- ]    c3</span><br><span class="line">  0 [*--- ]       c0</span><br><span class="line">error: tried to get an empty buffer</span><br></pre></td></tr></table></figure>
<p>我们很容易就出发了这个错误。问题就是消费者2消费的速度明显更快，然后在15行的地方很快消费了货物，但是消费者1在c3的地方苏醒过来，没有再次判断是不是“假唤醒”（课本260页提示，所谓假唤醒就是唤醒你，但是你但是你没有货物），然后它认为它是有货物取得，所以在20行本来应该是消费者1进行取货c4操作，但是没有货物引起报错。</p>
<h3 id="11"><a href="#11" class="headerlink" title="11."></a>11.</h3><p><img src="/2022/05/19/OS-thread-homework/image-20220516112113947.png" alt="image-20220516112113947"></p>
<p>我们最后考察一个这样的程序<code>main-two-cvs-while-extra-unlock.c</code>。考察它会发生什么样的问题。如果你在放一个货物或者取一个货物之前就释放锁会发生什么。你可依托这一点给出一个睡眠字符串吗？分析发生了什么不好的事情。</p>
<p>和前面的代码不同的地方就在于它的生产者和消费者函数，是在释放锁之后才取资源。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">do_fill</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">    <span class="comment">// ensure empty before usage</span></span><br><span class="line">    ensure(buffer[fill_ptr] == EMPTY, <span class="string">&quot;error: tried to fill a non-empty buffer&quot;</span>);</span><br><span class="line">    buffer[fill_ptr] = value;</span><br><span class="line">    fill_ptr = (fill_ptr + <span class="number">1</span>) % max;</span><br><span class="line">    num_full++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">do_get</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> tmp = buffer[use_ptr];</span><br><span class="line">    ensure(tmp != EMPTY, <span class="string">&quot;error: tried to get an empty buffer&quot;</span>);</span><br><span class="line">    buffer[use_ptr] = EMPTY; </span><br><span class="line">    use_ptr = (use_ptr + <span class="number">1</span>) % max;</span><br><span class="line">    num_full--;</span><br><span class="line">    <span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">producer</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    <span class="type">int</span> id = (<span class="type">int</span>) arg;</span><br><span class="line">    <span class="comment">// make sure each producer produces unique values</span></span><br><span class="line">    <span class="type">int</span> base = id * loops; </span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; loops; i++) &#123;   p0;</span><br><span class="line">        Mutex_lock(&amp;m);             p1;</span><br><span class="line">        <span class="keyword">while</span> (num_full == max) &#123;   p2;</span><br><span class="line">            Cond_wait(&amp;empty, &amp;m);  p3;</span><br><span class="line">        &#125;</span><br><span class="line">        Mutex_unlock(&amp;m);</span><br><span class="line">        do_fill(base + i);          p4;</span><br><span class="line">        Mutex_lock(&amp;m);</span><br><span class="line">        Cond_signal(&amp;fill);         p5;</span><br><span class="line">        Mutex_unlock(&amp;m);           p6;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">                                                                               </span><br><span class="line"><span class="type">void</span> *<span class="title function_">consumer</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    <span class="type">int</span> id = (<span class="type">int</span>) arg;</span><br><span class="line">    <span class="type">int</span> tmp = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> consumed_count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (tmp != END_OF_STREAM) &#123; c0;</span><br><span class="line">        Mutex_lock(&amp;m);            c1;</span><br><span class="line">        <span class="keyword">while</span> (num_full == <span class="number">0</span>) &#123;    c2;</span><br><span class="line">            Cond_wait(&amp;fill, &amp;m);  c3;</span><br><span class="line">        &#125;</span><br><span class="line">        Mutex_unlock(&amp;m);</span><br><span class="line">        tmp = do_get();            c4;</span><br><span class="line">        Mutex_lock(&amp;m);</span><br><span class="line">        Cond_signal(&amp;empty);       c5;</span><br><span class="line">        Mutex_unlock(&amp;m);          c6;</span><br><span class="line">        consumed_count++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// return consumer_count-1 because END_OF_STREAM does not count</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span> *) (<span class="type">long</span> <span class="type">long</span>) (consumed_count - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们的公共资源就是buffer，但是把<code>do_fill</code>和<code>do_get</code>放在锁的外面，这个锁就不起作用了。</p>
<p>如果只有一个消费者和生产者由于条件变量和full_num的共同作用，能够保证生产时消费者在睡，消费时生产者在睡。但是，如果有多个生产者和多个消费者的情况下，由于只能保证一个生产者和一个消费者互斥。所以其他的就可以对公共资源进行改写。比如在一个消费者取货物之前可能另外一个生产者覆盖了这个货物。</p>
<p><img src="/2022/05/19/OS-thread-homework/image-20220516114048979.png" alt="image-20220516114048979"></p>
<p>比如这里的2是被消费者0消费了，但是它很可能在c4消费之前，他消费的东西就被别的消费者覆盖了。</p>
<p>我们可以让c4执行慢一点，刚好让别的生产者抢占锁</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-C 0,0,0,0,5,0,0:0,0,0,0,5,0,0</span><br></pre></td></tr></table></figure>
<h2 id="第31章"><a href="#第31章" class="headerlink" title="第31章"></a>第31章</h2><h3 id="1-3"><a href="#1-3" class="headerlink" title="1."></a>1.</h3><p><img src="/2022/05/19/OS-thread-homework/image-20220517094824131.png" alt="image-20220517094824131"></p>
<p>第一题要我们实现fork/join问题，要求自己写一个线程fork-join的程序，你要工作的是作业目录下的<code>fork-join.c</code>文件。同时在<code>child</code>添加<code>sleep(1)</code>试着确定他的正确性。</p>
<p>和课本266页一致，但是要注意几点：</p>
<ul>
<li><code>child</code>释放<code>post</code>信号量应该在孩子已经工作完的情况下</li>
<li>创建完子线程之后，主线程等待子线程完毕</li>
</ul>
<p>下面书写代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;common_threads.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">sem_t</span> s; </span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">child</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;child\n&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1</span>); <span class="comment">// 验证父线程是否等待子线程完成</span></span><br><span class="line">    <span class="comment">// use semaphore here</span></span><br><span class="line">    Sem_post(&amp;s)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">pthread_t</span> p;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;parent: begin\n&quot;</span>);</span><br><span class="line">    <span class="comment">// init semaphore here</span></span><br><span class="line">    Sem_init(&amp;s, <span class="number">0</span>)</span><br><span class="line">    Pthread_create(&amp;p, <span class="literal">NULL</span>, child, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// use semaphore here</span></span><br><span class="line">    Sem_wait(&amp;s)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;parent: end\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于上述代码有几点说明：</p>
<ul>
<li>这里关于信号量的使用用的是宏定义函数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> Sem_init(sem, value)                             assert(sem_init(sem, 0, value) == 0);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Sem_wait(sem)                                    assert(sem_wait(sem) == 0);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Sem_post(sem)                                    assert(sem_post(sem) == 0);</span></span><br></pre></td></tr></table></figure>
<ul>
<li>运行编译时，需要加上<code>-pthread</code>的<code>tag</code>运行结果如下</li>
</ul>
<p>​    <img src="/2022/05/19/OS-thread-homework/image-20220517114856648.png" alt="image-20220517114856648"></p>
<ul>
<li>当加入<code>sleep(1)</code>的时候同样运行正确，验证代码正确性。</li>
</ul>
<h3 id="2-3"><a href="#2-3" class="headerlink" title="2."></a>2.</h3><p><img src="/2022/05/19/OS-thread-homework/image-20220517115033332.png" alt="image-20220517115033332"></p>
<p>现在看看<code>rendezvous</code>问题。这个问题表述如下：你有两个线程，每一个线程都将要进入到<code>rendezvous</code>点执行代码。每一部分都不会在其他线程进入这个代码的时候退出，而是等待。思考使用两个信号量实现这个过程。详见<code>rendezvous.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;common_threads.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果编写的代码正确，每一个子线程会打印各自的before信息，然后再打印各自的after信息</span></span><br><span class="line"><span class="comment">// 加入sleep(1)测试程序正确性</span></span><br><span class="line"></span><br><span class="line"><span class="type">sem_t</span> s1, s2;</span><br><span class="line"><span class="comment">// 两个信号量用于分别管理child1和child2的等待和继续</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">child_1</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;child 1: before\n&quot;</span>);</span><br><span class="line">    <span class="comment">// what goes here?</span></span><br><span class="line">    Sem_wait(&amp;s1)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;child 1: after\n&quot;</span>);</span><br><span class="line">    Sem_post(&amp;s2)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">child_2</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">	sleep(<span class="number">1</span>);	<span class="comment">// 先睡一会在工作</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;child 2: before\n&quot;</span>);</span><br><span class="line">    <span class="comment">// what goes here?</span></span><br><span class="line">    Sem_post(&amp;s1)</span><br><span class="line">    Sem_wait(&amp;s2)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;child 2: after\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">pthread_t</span> p1, p2;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;parent: begin\n&quot;</span>);</span><br><span class="line">    <span class="comment">// init semaphores here</span></span><br><span class="line">    Sem_init(&amp;s1, <span class="number">0</span>)</span><br><span class="line">    Sem_init(&amp;s2, <span class="number">0</span>)</span><br><span class="line">    Pthread_create(&amp;p1, <span class="literal">NULL</span>, child_1, <span class="literal">NULL</span>);</span><br><span class="line">    Pthread_create(&amp;p2, <span class="literal">NULL</span>, child_2, <span class="literal">NULL</span>);</span><br><span class="line">    Pthread_join(p1, <span class="literal">NULL</span>);</span><br><span class="line">    Pthread_join(p2, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;parent: end\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一点说明：这里把信号量作为条件变量使用，当条件变量发生变化，可以继续执行。可以看到如果<code>child1</code>先工作，它打印完它的before信息之后，会等待s1的讯息。然后<code>child2</code>输出它的before信息，然后它唤醒<code>child1</code>，然后自己进入睡眠等待<code>child1</code>打印它的after信息，然后<code>child1</code>打印完会唤醒<code>child2</code>，<code>child2</code>打印after讯息。最终实现次序打印。</p>
<p>结果如下：</p>
<p><img src="/2022/05/19/OS-thread-homework/image-20220517121316512.png" alt="image-20220517121316512"></p>
<h3 id="4-3"><a href="#4-3" class="headerlink" title="4."></a>4.</h3><p><img src="/2022/05/19/OS-thread-homework/image-20220517123707241.png" alt="image-20220517123707241"></p>
<p>这道题要求我们自己编写读写锁的详细代码。在这里我们不需要考虑饿死的问题。</p>
<p>代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;common_threads.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Your code goes in the structure and functions below</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">rwlock_t</span> &#123;</span></span><br><span class="line">    <span class="type">sem_t</span> lock;						<span class="comment">// 二值信号量，用作基础锁，保证对readers操作的原子性</span></span><br><span class="line">    <span class="type">sem_t</span> writelock;				<span class="comment">// 写锁</span></span><br><span class="line">    <span class="type">int</span> readers;					<span class="comment">// 读者的数量</span></span><br><span class="line">&#125; <span class="type">rwlock_t</span>;</span><br><span class="line"></span><br><span class="line">			</span><br><span class="line"><span class="type">void</span> <span class="title function_">rwlock_init</span><span class="params">(<span class="type">rwlock_t</span> *rw)</span> &#123;</span><br><span class="line">    rw-&gt;readers = <span class="number">0</span>;				<span class="comment">// 读者的数量</span></span><br><span class="line">    Sem_init(&amp;rw-&gt;lock, <span class="number">1</span>)			<span class="comment">// 基础锁初始化</span></span><br><span class="line">    Sem_init(&amp;rw-&gt;writelock, <span class="number">1</span>)		<span class="comment">// 写锁初始化</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rwlock_acquire_readlock</span><span class="params">(<span class="type">rwlock_t</span> *rw)</span> &#123;</span><br><span class="line">    Sem_wait(&amp;rw-&gt;lock)</span><br><span class="line">    rw-&gt;readers++;</span><br><span class="line">    <span class="keyword">if</span> (rw-&gt;readers == <span class="number">1</span>)</span><br><span class="line">        Sem_wait(&amp;rw-&gt;writelock)</span><br><span class="line">    Sem_post(&amp;rw-&gt;lock)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rwlock_release_readlock</span><span class="params">(<span class="type">rwlock_t</span> *rw)</span> &#123;</span><br><span class="line">    Sem_wait(&amp;rw-&gt;lock)</span><br><span class="line">    rw-&gt;readers--;</span><br><span class="line">    <span class="keyword">if</span> (rw-&gt;readers == <span class="number">0</span>)</span><br><span class="line">        Sem_post(&amp;rw-&gt;writelock)</span><br><span class="line">    Sem_post(&amp;rw-&gt;lock)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rwlock_acquire_writelock</span><span class="params">(<span class="type">rwlock_t</span> *rw)</span> &#123;</span><br><span class="line">    Sem_wait(&amp;rw-&gt;writelock)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rwlock_release_writelock</span><span class="params">(<span class="type">rwlock_t</span> *rw)</span> &#123;</span><br><span class="line">    Sem_post(&amp;rw-&gt;writelock)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Don&#x27;t change the code below (just use it!)</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> loops;</span><br><span class="line"><span class="type">int</span> value = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">rwlock_t</span> lock;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">reader</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; loops; i++) &#123;</span><br><span class="line">        rwlock_acquire_readlock(&amp;lock);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;read %d\n&quot;</span>, value);</span><br><span class="line">        rwlock_release_readlock(&amp;lock);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">writer</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; loops; i++) &#123;</span><br><span class="line">        rwlock_acquire_writelock(&amp;lock);</span><br><span class="line">        value++;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;write %d\n&quot;</span>, value);</span><br><span class="line">        rwlock_release_writelock(&amp;lock);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="comment">// 获取参数</span></span><br><span class="line">    assert(argc == <span class="number">4</span>);</span><br><span class="line">    <span class="type">int</span> num_readers = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="type">int</span> num_writers = atoi(argv[<span class="number">2</span>]);</span><br><span class="line">    loops = atoi(argv[<span class="number">3</span>]);</span><br><span class="line">    <span class="comment">// 创建进程池</span></span><br><span class="line">    <span class="type">pthread_t</span> pr[num_readers], pw[num_writers];</span><br><span class="line">    <span class="comment">// 读写锁初始化</span></span><br><span class="line">    rwlock_init(&amp;lock);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;begin\n&quot;</span>);</span><br><span class="line">    <span class="comment">// 创建所有读者和写着</span></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_readers; i++)</span><br><span class="line">        Pthread_create(&amp;pr[i], <span class="literal">NULL</span>, reader, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_writers; i++)</span><br><span class="line">        Pthread_create(&amp;pw[i], <span class="literal">NULL</span>, writer, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// 主线程等待所有读者写者完成任务</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_readers; i++)</span><br><span class="line">        Pthread_join(pr[i], <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_writers; i++)</span><br><span class="line">        Pthread_join(pw[i], <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;end: value %d\n&quot;</span>, value);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下</p>
<p><img src="/2022/05/19/OS-thread-homework/image-20220517131624836.png" alt="image-20220517131624836"></p>
<p>存在读者饿死写着的问题。看到上面的实验结果显示只有读者全部读完了才开始写。根据代码我们也可以看出来。第一个读者获取写锁，所以任何写者都不可以写，而在第一个读者获得写锁后，其他的读者是可以获得读锁的。一旦某一个读者抢到了写锁，其他的读者都会蜂拥而入（它们不受任何阻碍）然后执行读操作。而写者呢？它们很不幸，如果它们没有任何一个读者快抢到<code>writelock</code>，则它们不能够执行写，因为<code>writelock</code>还在第一个读者手上(<code>writelock</code>移交到最后一个读者手上了才释放)，所以这些读者只能够等待几乎所有读者读完才能够进行写操作。同时还要保证在它们被最后一个读者唤醒之后没有其他读者和他们竞争，才能够安稳进行写操作。</p>
<h3 id="5-1"><a href="#5-1" class="headerlink" title="5."></a>5.</h3><p><img src="/2022/05/19/OS-thread-homework/image-20220517133750012.png" alt="image-20220517133750012"></p>
<p>现在我们要写一个没有上面描述到的饥饿问题的程序。实际上我们需要做到的是：如何能够在有写者等待的时候，避免有更多的读者进入并持有锁。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;common_threads.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Your code goes in the structure and functions below</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">rwlock_t</span> &#123;</span></span><br><span class="line">    <span class="type">sem_t</span> lock;						<span class="comment">// 二值信号量，用作基础锁</span></span><br><span class="line">    								<span class="comment">// 保证对writers和readers操作的原子性</span></span><br><span class="line">    <span class="type">sem_t</span> writelock;				<span class="comment">// 写锁</span></span><br><span class="line">    <span class="type">int</span> readers;					<span class="comment">// 读者的数量</span></span><br><span class="line">    <span class="type">int</span> writers;</span><br><span class="line">&#125; <span class="type">rwlock_t</span>;</span><br><span class="line"></span><br><span class="line">			</span><br><span class="line"><span class="type">void</span> <span class="title function_">rwlock_init</span><span class="params">(<span class="type">rwlock_t</span> *rw)</span> &#123;</span><br><span class="line">    rw-&gt;readers = <span class="number">0</span>;				<span class="comment">// 读者的数量</span></span><br><span class="line">    rw-&gt;writers = <span class="number">0</span>;				<span class="comment">// 等待写的写者数量</span></span><br><span class="line">    Sem_init(&amp;rw-&gt;lock, <span class="number">1</span>)			<span class="comment">// 基础锁初始化</span></span><br><span class="line">    Sem_init(&amp;rw-&gt;writelock, <span class="number">1</span>)		<span class="comment">// 写锁初始化</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rwlock_acquire_readlock</span><span class="params">(<span class="type">rwlock_t</span> *rw)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    Sem_wait(&amp;rw-&gt;lock)</span><br><span class="line">    <span class="keyword">while</span> (rw-&gt;writers &gt; <span class="number">0</span>)			<span class="comment">// 判断是否有写者进行等待</span></span><br><span class="line">        ; <span class="comment">// spin					// 自旋等待</span></span><br><span class="line">    rw-&gt;readers++;</span><br><span class="line">    <span class="keyword">if</span> (rw-&gt;readers == <span class="number">1</span>)</span><br><span class="line">        Sem_wait(&amp;rw-&gt;writelock)</span><br><span class="line">    Sem_post(&amp;rw-&gt;lock)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rwlock_release_readlock</span><span class="params">(<span class="type">rwlock_t</span> *rw)</span> &#123;</span><br><span class="line">    Sem_wait(&amp;rw-&gt;lock)</span><br><span class="line">    rw-&gt;readers--;</span><br><span class="line">    <span class="keyword">if</span> (rw-&gt;readers == <span class="number">0</span>)</span><br><span class="line">        Sem_post(&amp;rw-&gt;writelock)</span><br><span class="line">    Sem_post(&amp;rw-&gt;lock)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rwlock_acquire_writelock</span><span class="params">(<span class="type">rwlock_t</span> *rw)</span> &#123;</span><br><span class="line">    <span class="comment">// 写者申请写锁前先将等待数目加一</span></span><br><span class="line">    Sem_wait(&amp;rw-&gt;lock)</span><br><span class="line">    rw-&gt;writers++;</span><br><span class="line">    Sem_post(&amp;rw-&gt;lock)</span><br><span class="line">    <span class="comment">// 申请写锁</span></span><br><span class="line">    Sem_wait(&amp;rw-&gt;writelock)</span><br><span class="line">    <span class="comment">// 写者获得写锁把等待数目减一</span></span><br><span class="line">    Sem_wait(&amp;rw-&gt;lock)</span><br><span class="line">    rw-&gt;writers--;</span><br><span class="line">    Sem_post(&amp;rw-&gt;lock)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rwlock_release_writelock</span><span class="params">(<span class="type">rwlock_t</span> *rw)</span> &#123;</span><br><span class="line">    Sem_post(&amp;rw-&gt;writelock)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面的代码和上面的文件没有什么区别</span></span><br></pre></td></tr></table></figure>
<p>这种策略实际上是一种写者优先的策略。由于读写锁的策略是针对多数读者少数写者的情况。这里我采用简单的自旋技术，让读者在申请锁之前总需要先判断一下是否有写者等待，如果有读者自选等待。然后在<code>rwlock_acquire_writelock</code>的代码中对<code>writers</code>的改写需要保证原子性，所以需要上锁。但是我们需要把锁的范围缩小到上面的仅对加减<code>writers</code>的操作上锁解锁。从第51行到第53行可能发生中断，使得尽管写者已经释放了锁，但是等待数目没有来得及减。但是此时所有读者仍然在等待减完才能抢占CPU。这一点在这里不用担心。</p>
<p>最后我们看一种夸张的情况，每一个读者在抢占锁之前都睡眠一秒钟。结果显示能够让写者先进行写操作。说明我们解决了饥饿的问题。</p>
<p><img src="/2022/05/19/OS-thread-homework/image-20220517145756037.png" alt="image-20220517145756037"></p>
<h3 id="6-1"><a href="#6-1" class="headerlink" title="6."></a>6.</h3><p><img src="/2022/05/19/OS-thread-homework/image-20220517145842415.png" alt="image-20220517145842415"></p>
<p>现在要用信号量实现没有饥饿问题的互斥量也就是锁。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;common_threads.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Here, you have to write (almost) ALL the code. Oh no!</span></span><br><span class="line"><span class="comment">// How can you show that a thread does not starve</span></span><br><span class="line"><span class="comment">// when attempting to acquire this mutex you build?</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">ns_mutex_t</span> &#123;</span></span><br><span class="line">	<span class="type">int</span> ticket;</span><br><span class="line">	<span class="type">int</span> turn;</span><br><span class="line">	<span class="type">sem_t</span> stic;</span><br><span class="line">	<span class="type">sem_t</span> stur;</span><br><span class="line">&#125; <span class="type">ns_mutex_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ns_mutex_init</span><span class="params">(<span class="type">ns_mutex_t</span> *m)</span> &#123;</span><br><span class="line">	Sem_init(&amp;m-&gt;stic, <span class="number">1</span>)</span><br><span class="line">	Sem_init(&amp;m-&gt;stur, <span class="number">1</span>)</span><br><span class="line">	m-&gt;ticket = <span class="number">0</span>;</span><br><span class="line">	m-&gt;turn = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ns_mutex_acquire</span><span class="params">(<span class="type">ns_mutex_t</span> *m)</span> &#123;</span><br><span class="line">	<span class="comment">// FetchAndAdd(&amp;m-&gt;stic)</span></span><br><span class="line">	Sem_wait(&amp;m-&gt;stic)</span><br><span class="line">	<span class="type">int</span> myturn = m-&gt;ticket++;</span><br><span class="line">	Sem_post(&amp;m-&gt;stic)</span><br><span class="line">    <span class="comment">// 自旋等待轮询到自己</span></span><br><span class="line">	<span class="keyword">while</span> (m-&gt;turn != myturn)</span><br><span class="line">		; <span class="comment">// spin</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ns_mutex_release</span><span class="params">(<span class="type">ns_mutex_t</span> *m)</span> &#123;</span><br><span class="line">	<span class="comment">// FetchAndAdd(&amp;m-&gt;stur)</span></span><br><span class="line">	Sem_wait(&amp;m-&gt;stur)</span><br><span class="line">	m-&gt;turn++;</span><br><span class="line">	Sem_post(&amp;m-&gt;stur)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> value = <span class="number">0</span>;</span><br><span class="line"><span class="type">ns_mutex_t</span> lock;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">worker</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">	ns_mutex_acquire(&amp;lock);</span><br><span class="line">	<span class="type">int</span> tmp = value++;</span><br><span class="line">	ns_mutex_release(&amp;lock);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;tid: %ld &gt; %d\n&quot;</span>, pthread_self(), tmp);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">	assert(argc == <span class="number">2</span>);</span><br><span class="line">	<span class="type">int</span> num_workers = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">	</span><br><span class="line">	<span class="type">pthread_t</span> pool[num_workers];</span><br><span class="line">	ns_mutex_init(&amp;lock);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;parent: begin\n&quot;</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num_workers; i++)</span><br><span class="line">		Pthread_create(&amp;pool[i], <span class="literal">NULL</span>, worker, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num_workers; i++)</span><br><span class="line">		Pthread_join(pool[i], <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;parent: end\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于上面的代码，我们需要的是公平性，我们可以通过学习Mellor-Crummey和Michael Scott提出来的ticket和turn的机制（课本228页）写出代码如上。主要是用了这种turn的轮询机制。通过锁的全局<code>ticket</code>和<code>turn</code>，以及每个线程申请时的<code>myturn</code>来实现公平。课本上主要使用原语<code>FetchAndAdd</code>实现对<code>lock-&gt;turn</code>和<code>lock-&gt;ticket</code>原子操作，这里我们用信号量生成的锁来实现这种原语。其实上面带有<code>FetchAndAdd</code>的注释的地方的代码相当于下面</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FetchAndAdd(sema) &#123;</span></span><br><span class="line">	Sem_wait(&amp;m-&gt;stic)			 \</span><br><span class="line">	<span class="comment">/* 某些操作 */</span>				  \</span><br><span class="line">	Sem_post(&amp;m-&gt;stic)			\</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终运行结果如下，我们可以清楚看到，每个线程都调度了，达到了相对的公平性。</p>
<p><img src="/2022/05/19/OS-thread-homework/image-20220519222752600.png" alt="image-20220519222752600"></p>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/ostep-homework/" rel="tag"><i class="fa fa-tag"></i> ostep-homework</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item"></div>
      <div class="post-nav-item">
    <a href="/2022/05/26/CSAPP-shlab-report/" rel="next" title="CSAPP:shlab-report">
      CSAPP:shlab-report <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E4%BD%9C%E4%B8%9A"><span class="nav-number">1.</span> <span class="nav-text">操作系统第三部分作业</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%9C%E4%B8%9A%E8%8C%83%E5%9B%B4"><span class="nav-number">1.1.</span> <span class="nav-text">作业范围</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC26%E7%AB%A0"><span class="nav-number">1.2.</span> <span class="nav-text">第26章</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3"><span class="nav-number">1.2.3.</span> <span class="nav-text">3.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4"><span class="nav-number">1.2.4.</span> <span class="nav-text">4.</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC28%E7%AB%A0"><span class="nav-number">1.3.</span> <span class="nav-text">第28章</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1"><span class="nav-number">1.3.1.</span> <span class="nav-text">1.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1"><span class="nav-number">1.3.2.</span> <span class="nav-text">2.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1"><span class="nav-number">1.3.3.</span> <span class="nav-text">3.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1"><span class="nav-number">1.3.4.</span> <span class="nav-text">4.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5"><span class="nav-number">1.3.5.</span> <span class="nav-text">5.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6"><span class="nav-number">1.3.6.</span> <span class="nav-text">6.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7"><span class="nav-number">1.3.7.</span> <span class="nav-text">7.</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC30%E7%AB%A0"><span class="nav-number">1.4.</span> <span class="nav-text">第30章</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2"><span class="nav-number">1.4.1.</span> <span class="nav-text">1.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2"><span class="nav-number">1.4.2.</span> <span class="nav-text">2.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2"><span class="nav-number">1.4.3.</span> <span class="nav-text">4.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8"><span class="nav-number">1.4.4.</span> <span class="nav-text">8.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9"><span class="nav-number">1.4.5.</span> <span class="nav-text">9.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10"><span class="nav-number">1.4.6.</span> <span class="nav-text">10.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11"><span class="nav-number">1.4.7.</span> <span class="nav-text">11.</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC31%E7%AB%A0"><span class="nav-number">1.5.</span> <span class="nav-text">第31章</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3"><span class="nav-number">1.5.1.</span> <span class="nav-text">1.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3"><span class="nav-number">1.5.2.</span> <span class="nav-text">2.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3"><span class="nav-number">1.5.3.</span> <span class="nav-text">4.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1"><span class="nav-number">1.5.4.</span> <span class="nav-text">5.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1"><span class="nav-number">1.5.5.</span> <span class="nav-text">6.</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Puitar</p>
  <div class="site-description" itemprop="description">博客萌新时不时送来没什么软用的文章</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">13</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    Chat
  </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/PUITAR" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;PUITAR" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/1831979740@qq.com" title="E-Mail → 1831979740@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Puitar</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>















  

  

  

</body>
</html>
